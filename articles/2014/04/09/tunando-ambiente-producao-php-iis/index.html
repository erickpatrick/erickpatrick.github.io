<!doctype html>
<html lang="pt-BR" itemscope itemtype="http://schema.org/Person">
<head>
  <meta charset="utf-8">
  <meta name=viewport content="width=device-width, initial-scale=1">
  <title>Tunando o Ambiente de produção PHP no IIS | Erick Patrick</title>
  <meta name="description" content="Olá, sou Erick Patrick. Presto consultoria especializada em programação para web. Também traduzo e escrevo sobre desenvolvimento web.">
  <meta name="author" content="Erick Patrick">

  <!-- Twitter card -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@erickpatrick">
  <meta name="twitter:title" content="Página Inicial | Erick Patrick">
  <meta name="twitter:description" content="Olá, sou Erick Patrick. Presto consultoria especializada em programação para web. Também traduzo e escrevo sobre desenvolvimento web.">
  <meta name="twitter:creator" content="@erickpatrick">
  <meta name="twitter:image:src" content="http://erickpatrick.net/img/me.jpg">
  <meta name="twitter:domain" content="http://erickpatrick.net">

  <!-- Facebook Meta Tags -->
  <meta property="og:url" content="http://www.erickpatrick.net"/>
  <meta property="og:title" content="Página Inicial | Erick Patrick"/>
  <meta property="og:image" content="http://erickpatrick.net/img/me.jpg"/>
  <meta property="og:site_name" content="Erick Patrick - Desenvolvimento para Web"/>
  <meta property="og:description" content="Olá, sou Erick Patrick. Presto consultoria especializada em programação para web. Também traduzo e escrevo sobre desenvolvimento web."/>

  <!-- FB Insights -->
  <meta property="fb:admins" content="1386933601" />

  <!-- Google+ Meta Tags -->
  <meta itemprop="name" content="Página Inicial | Erick Patrick">
  <meta itemprop="description" content="Olá, sou Erick Patrick. Presto consultoria especializada em programação para web. Também traduzo e escrevo sobre desenvolvimento web.">
  <meta itemprop="image" content="http://erickpatrick.net/img/me.jpg">

  <link rel="author" href="http://google.com/+ErickPatrick1988" />
  <link rel="publisher" href="https://plus.google.com/b/106544148188542649191/106544148188542649191/posts">

  <!--<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans:300">-->

  <style>
    * {padding:0;margin:0;box-sizing: border-box;}
    body {font:normal normal 1em/1.35 'Open Sans', Arial, sans-serif; }
    h1 { font-size:3.5em; }
    h2 { font-size:3em; }
    h3 { font-size:2.5em; }
    h4 { font-size:2em; }
    h5 { font-size:1.5em; }

    html, body {height: 100%;}

    .btn {display: block; padding:.75em; margin:1em 0; text-decoration:none; color:#fff; font-size:1.25em;}

    .header {position:relative; display: table;height:100%;width:100%;min-height: 100%;background:#34495e url(http://erickpatrick.net/img/background.jpg) center center no-repeat; background-size: cover; }
    .header__small {position:relative; display: table;height:300px%;width:100%;background:#34495e url(http://erickpatrick.net/img/background.jpg) center center no-repeat; padding:2em; margin-bottom:1em;}
    .header__wrapper {display: table-cell;vertical-align:middle;text-align:center;width:100%; color:#fff; padding:1em;}
    .header__small .header__wrapper {text-align: left; overflow: hidden}
    .header__title,.header__subtitle,.header__menu__item a {text-shadow:0 0 50px #342735;}
    .header__title {font-size:4.5em;line-height:1;}
    .header__subtitle {font-size:1.25em;}
    .header__cta {background:#694d6f;}
    .header__cta:hover {background:#472b4d;}
    /**inner pages**/
    .header__menu {list-style: none; overflow: hidden; padding:1em 0;}
    .header__menu__item {display: block;}
    .header__menu__item a,
    .header__menu__item a:visited {color:#fff; font-size:2em; margin-left:-.5em; padding:.5em; text-decoration:none; }
    .header__menu__item a:hover {text-decoration: underline;}

    .column {display: inline-block; width:100%; vertical-align: top;}

    .main {color:#694d6f;}
    .main--inner {padding:1em;}
    .main a {color:#694d6f;}
    .main a:hover {color:#472b4d;}

    .content__header {padding-bottom:1em; border-bottom: 1px #efefef solid; margin-bottom:1em;}
    .content__header h5 {color:#a68eab;}
    .content__text p,
    .content__text img,
    .content__text ul,
    .content__text blockquote,
    .content__text h4,
    .content__text h5,
    .content__text h6 {margin-bottom: 1em;}
    .content__text p,
    .content__text ul,
    .content__text blockquote { color:#111;}
    .content__text ul {margin-left:1em;}
    .content__text li {margin:.5em 0;}
    .content__text img {max-width:100%;}

    .aside {}
    .aside__featured {padding:1em; background:#efefef;}
    .aside__featured img {max-width:100%;}

    .copyright {text-align: center; padding-bottom: 1em; color:#694d6f;}

    /*480*/
    @media only screen and (min-width:30em) {
      .btn {display:inline-block;}
      .header__menu__item {display: inline-block;}
    }

    /*640*/
    @media only screen and (min-width:40em) {
      .header {font-size:1.375em;}
      .content__text p,
      .content__text ul {font-size:1.15em;}
    }

    @media only screen and (min-width:60em) {
      .column {width:25%;}
      .column--2 {width:50%;}
      .column--3 {width:75%;}

      .content {padding-right:3em;}
      .content__text p,
      .content__text ul {font-size:1.35em;}

      .content__text {overflow: hidden}
      .content__img__left {float:left; padding-right:2em;}
    }

    /*1024*/
    @media only screen and (min-width:64em) {
      .header__subtitle {font-size:1.5em;}
    }

    /*1120*/
    @media only screen and (min-width:70em) {
      .wrapper {width:90%; max-width:1140px; margin:0 auto;}
      .header, .footer {font-size:1.5em;}
    }

    @media only screen and (min-width:80em) {
      .header__subtitle {font-size:2em;}
    }

  </style>
</head>
<body>
  <header class="header__small">
    <div class="header__wrapper">
      <h1 class="header__title">Erick Patrick</h1>
      <ul class="header__menu">
        <li class="header__menu__item"><a href="http://erickpatrick.net">Inicial</a></li>
        <li class="header__menu__item"><a href="http://erickpatrick.net/pages/services/">Serviços</a></li>
        <li class="header__menu__item"><a href="http://erickpatrick.net/articles/">Artigos</a></li>
        <li class="header__menu__item"><a href="http://erickpatrick.net/books/">Livros</a></li>
        <li class="header__menu__item"><a href="http://erickpatrick.net/pages/contact/">Contato</a></li>
      </ul>
    </div>
  </header>
  <div class="wrapper main main--inner">
    <section class="column column--3 content">
      <div class="content__header">
        <span class="content__meta">09 de Abril de 2014</span>
        <h3>Tunando o Ambiente de produção PHP no IIS</h3>
        <h5>Aprenda a dominar essa monstro de sete cabeças e torná-lo seu animal de estimação</h5>
      </div>
      <div class="content__text">
        <p>Que o habitat natural do PHP são os ambientes *nix, todos nós sabemos. Contudo, há empresas que, por possuírem seu principal produto, serviço ou aplicativo rodando num stack Microsoft, não é incomum vermos o PHP rodando em servidores IIS.</p>
        <p>Geralmente, isso acontece por essas empresas decidirem usar a plataforma de gerenciamento de conteúdo (<em>cms</em>) WordPress, como base para seus sites. Essa escolha se dá pela facilidade de uso e customização, além da grande quantidade de programadores que desenvolvem para WordPress, tanto brasileiros quando estrangeiros.</p>
        <p>Após tomarem essa decisão e colocarem o site em produção, eles percebem que ele não aparenta estar tão performático quanto poderia estar. Algumas empresas aceitam essa performance, em troca da facilidade do uso e gerenciamento proporcionados pelo sistema, porém, outras não aceitam.</p>
        <p>Essas outras costumam ter acessos nas casa das dezenas de milhares, às vezes, centenas de milhares ou mesmo milhões de acessos. Elas precisam otimizar o ambiente e o sistema da melhor forma possível.</p>
        <p>É por isso que esse post foi criado. Embora não seja específico para WordPress, grande parte do conhecimento presente nesse post se deve à busca de otimização de um ambiente IIS+PHP rodando WordPress. No entanto, ele deve servir para qualquer outro sistema, além do WordPress.</p>
        <h4>VM exclusivas para cada sistema</h4>
        <p>Não misture seu site com seu sistema financeiro, com seu sistema ERP, com a base de dados em um único servidor/máquina virtual.</p>
        <p>Por mais que eles sejam bastante integrados, tentar desacopla-los é uma das melhores coisas que você pode fazer para sua sanidade e vida útil de suas aplicações e servidores.</p>
        <p>Se, por alguma motivo, alguma das aplicações precisar atualizar alguma dependência, não precisará se preocupar se essa dependência não afetará outros sistemas. Tome, sempre, muito cuidado.</p>
        <h4>Instale o Web Platform Installer (Web PI)</h4>
        <p>A primeira coisa que você deve fazer, é usar o gerenciador do IIS e instalar o Web Platform Installer. Além de ser pequeno (apenas 2Mb), ele permite que você obtenha os aplicativos necessários para rodar suas aplicações da maneira mais fácil possível: Busca e clicar para instalar.</p>
        <p>Com ele, é possível instalar o PHP, o IIS, o WordPress e inúmeras outros itens (inclusive, outros que estão presentes nesse post) sem suar. Não deixe de instalá-lo.</p>
        <h4>Instale o PHP em modo fast_cgi</h4>
        <p>Quando for buscar o PHP para instalar através do Web PI, a não ser que sua aplicação encontre alguma incompatibilidade, dê preferência pela versão mais recente, que, até o momento desse post, é a 5.5.8.</p>
        <p>Geralmente, o Web PI se encarrega em instalar o PHP em modo fast_cgi e configurar o arquivo php.ini automaticamente, para que você não precise se preocupar (não disse que seria sem suar?).</p>
        <p>Entretanto, já me deparei em 2 situações que isso não aconteceu. Então, rode o famoso phpinfo() para saber as informações da instalação e certifique-se do modo sendo usado.</p>
        <p>Utilizar esse modo (fast_cgi) ajuda a diminuir a sobrecarga do servidor durante as requisições e processamentos em relação ao PHP.</p>
        <h4>Cuidados com o PHP</h4>
        <p>Dependendo da framework utilizada, é preciso realizar testes para que nenhum problema ocorra com as versões mais recentes. No meu caso, por exemplo, em que tenho algumas aplicações em Laravel 3, ao atualizar para a versão v5.5.x do PHP, as aplicações deixaram de funcionar.</p>
        <p>Depois de muito bater cabeça e de muita leitura, descobri que era pelo fato do PHP 5.5.x e do LAravel estarem em choque com relação a nomenclatura de funções. Mais precisamente, a função yield, adicionada ao PHP “recentemente”.</p>
        <p>Como o Laravel 3 não é mais suportado, tive de mexer no core do mesmo para resolver o meu problema. Então, se possível, façam testes, nem que seja usando aplicativos como WAMP, para testar suas aplicações.</p>
        <h4>USE PDO</h4>
        <p>A principal vantagem de escrever suas funções de acesso a base de dados, com PHP, usando PDO, é que você, basicamente e praticamente, fica agnóstico em relação ao banco usado, bastando alterar a linha de conexão e, talvez, uma ou outra função específica que só é suportado pelo SQL usado por um dado banco.</p>
        <p>Dessa forma, se você está usando MySQL no IIS e quer passar a usar SQL Server, para poder integrar alguns dados do seu sistema com os dados de algum sistema de terceiros (como o WordPress), utilizar o PDO lhe poupará inúmeras horas.</p>
        <p>Fora isso, você tem a vantagem de ser uma API mais robusta, orientada a objetos, com possibilidade de transações, parâmetros associados (bound parameters), suporte e muitos outros pontos que, para você saber, <a href="http://www.php.net/manual/en/book.pdo.php">pode acessar a página do PDO</a>.</p>
        <h4>Habilite PDO_SQLSRV.dll</h4>
        <p>É bem possível que, mesmo depois de instalar o SQL Server, você tenha de habilitar a PDO_SQLSRV.dll no php.ini.</p>
        <p>Ao invés de mexer manualmente no arquivo para habilitá-lo, acesse o painel do IIS e procure o gerenciador do PHP (que é instalado, automaticamente, no procedimento de instalação do PHP) e procure por bibliotecas/libraries e procure pela DLL em questão e habilite-a. Depois disso, reinicie o serviço e você poderá usar PDO com o SQL Server.</p>
        <p>Até agora, apesar de já ter a versão 5.5.8 do PHP para instalar através do Web PI, ainda não tem uma versão da DLL do SQL Server, mantida pela Miscrosoft, para instalar por lá, impedindo que você se conecte com esse banco.</p>
        <p>Então, é possível que você precise baixar a versão da comunidade, disponível <a href="http://sqlsrvphp.codeplex.com/discussions/441706">nesse tópico desse fórum</a>. Descompacte o arquivo Rar e procure o diretório de instalação do PHP (ficará dentro do diretório de serviços do IIS). Procure pela pasta ext e cole os arquivos lá. Depois disso, torne a voltar ao gerenciador do PHP, na parte de bibliotecas e procure pela biblioteca recém colocada. Habilite-a e reinicie o serviço.</p>
        <h4>Habilite o Fileinfo.dll</h4>
        <p>Várias frameworks PHP atuais utilizam-se do módulo FileInfo para descobrir quais os tipos de arquivos e a (melhor) codificação para os mesmos. A Laravel é uma delas, por exemplo, e descreve em sua página, que o módulo FileInfo esteja ativado.</p>
        <p>Porém, no Windows/IIS, esse módulo vem como uma DLL e desabilitada. Felizmente, ela já está presente na pasta ext do PHP e com uma versão própria para o PHP que for instalado. Só é preciso habilita-la. Mais uma vez, utilize o painel de gerenciamento do PHP para faze-lo e depois reinicie o serviço.</p>
        <h4>Instale e use WinCache.dll</h4>
        <p>O IIS permite a instalação de um sistema de cache bem interessante e que interage muito bem com o PHP, esse é o WinCache. Ele já está disponível para a versão mais recenete do PHP, inclusive.</p>
        <p>Para você ter uma ideia, quando recém lançamos o novo site da instituição, feito em WordPress, o tempo para a primeira resposta do servidor estava muito alto, beirando os 800ms. Em dados momentos, chegava aos 1000ms (sim, 1s para a primeira resposta do servidor).</p>
        <p>Para o dia-a-dia, esse valor já é muito alto (o recomendado é 200ms ou menos), imagine em momentos de pico, quando temos 5~10x o tráfego normal?</p>
        <p>Resolvemos instalar o WinCache, e, após instalá-lo, sem configurá-lo, só com os valores padrões, conseguimos baixar esse valor para uma média de 400ms. Um ganho tremendo, diga-se. Contudo, não estávamos satisfeitos e fomos atrás de bater os 200ms.</p>
        <p>Vasculhamos várias páginas em busca de maiores informações e descobrimos alguns truques. O primeiro deles, desabilite a opção wincache.fcndetect no php.ini. Essa opção, quando ativada, verifica, em todas as requisições, se houve mudanças nos arquivos para que possam ser gerados novos opcodes, gerando uma sobrecarga desnecessária. Logo após desabilita-la, verificamos tempos médios de 325ms. Outro ganho muito bom.</p>
        <p>Também mudamos outra configuração: fizemos com que o PHP utilize um arquivo chamado reroute.ini, criado pelo WinCache, que permite que algumas funções nativas de leitura e escrita de arquivos e de memória do utilizadas pelo PHP sejam “reescritas” para utilizar códigos masi eficientes.</p>
        <p>Quanto menor o tempo de resposta, mais difícil se torna em diminuir o tempo da primeira resposta. Mas, ao habilitar essa opção, saímos dos 325ms de tempo de resposta para uma média de 25ms!! Incrível!</p>
        <p>Há um porém: Alguns aplicativos PHP (como algumas Wikis) utilizam-se de certos comportamentos de algumas dessas funções nativas que são “reescritas” e deixam de funcionar. Por isso, mais uma vez, sempre façam testes antes de lançar em produção.</p>
        <p>Um outro problema que percebemos, ao utilizar o WinCache, se não mudarmos duas configurações (wincache.chkinterval e wincache.ttlmax) para valores bem próximos ao mínimo, os opcaches não se atualizam frequentemente para páginas parâmetos GET. Isso, em algumas ocasiões pode dar muito estresse e dor de cabeça.</p>
        <p>Avalie se suas aplicações não sofrerão quaisquer consequências drásticas pelo uso do WinCache. Se você verificar que não há nada determinante afetado, utilize-o. Você só tem a ganhar.</p>
        <p>Tudo isso posto, acredito que você terá um ambeinte de produção bastante performático. Porém, essas dicas não servirão de muita coisa se você não otimizar suas aplicações, tanto no <em>front-end</em> quanto no <em>back-end</em>.</p>
        <p>É aquela máxima: De que serve ter pistas lisinhas, como as alemãs autobans, se você tem, no máximo, uma motoca que alcança seus 60km/h? Não dá, não é?</p>
        <p>Até as próximas dicas.</p>
      </div>
    </section><!--
     --><aside class="column column aside">
      <div class="aside__featured">
        <a href="http://www.erickpatrick.net/books/iniciante-node/" title="Livro do Iniciante em Node"><img src="http://www.erickpatrick.net/books/iniciante-node/img/cover-thumb.jpg" alt="Capa d'O Livro do Iniciante em Node"></a>
      </div>
    </aside>
  </div>

  <footer class="footer wrapper copyright">
    <p>© <span id="copyright_year"></span> Erick Patrick</p>
  </footer>

  <script>
    window.onload = function() {
      var cy = document.getElementById('copyright_year');
      cy.appendChild(document.createTextNode((new Date).getFullYear()));
    }
  </script>
</body>
</html>